pipeline {
    agent any
    environment {
        JENKINS_URL = 'http://localhost:8080'
        GIT_CREDENTIALS_ID = 'jenkins-credentials'
        CSRF_TOKEN = ""
    }
    stages {
        stage('Get CSRF Token') {
            steps {
                script {
                    def response = httpRequest(
                        url: "${JENKINS_URL}/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)",
                        authentication: "${env.GIT_CREDENTIALS_ID}"
                    )
                    CSRF_TOKEN = response.trim()
                }
            }
        }
        stage('Build') {
            steps {
                echo 'Construction du projet...'
                httpRequest(
                    url: "${JENKINS_URL}/job/your_job/build",
                    authentication: "${env.GIT_CREDENTIALS_ID}",
                    httpMode: 'POST',
                    headers: [('Jenkins-Crumb': "${CSRF_TOKEN}")]
                )
                powershell 'mvn clean package'
            }
        }
        stage('Test') {
            steps {
                echo 'Ex√©cution des tests...'
                httpRequest(
                    url: "${JENKINS_URL}/job/your_job/build",
                    authentication: "${env.GIT_CREDENTIALS_ID}",
                    httpMode: 'POST',
                    headers: [('Jenkins-Crumb': "${CSRF_TOKEN}")]
                )
                powershell 'mvn test'
            }
        }
    }
}